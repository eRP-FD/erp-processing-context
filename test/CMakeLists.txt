#
# (C) Copyright IBM Deutschland GmbH 2021
# (C) Copyright IBM Corp. 2021
#

project(test)

include(GoogleTest)
enable_testing()

set(TEST_DATA_DIR "${CMAKE_SOURCE_DIR}/resources/test")
set(GENERATED_NOTE "This file has been generated by CMake")
configure_file("${CMAKE_CURRENT_SOURCE_DIR}/test_config.h.in" "${CMAKE_CURRENT_BINARY_DIR}/test_config.h")


set(ERP_TEST_LIB_SOURCES
        mock/ClientTeeProtocol.cxx
        util/JsonTestUtils.cxx
        workflow-test/A_21265_ProzessParameterFlowtype.cxx
        workflow-test/A_21370_CheckPrescriptionIdOnActivate.cxx
        workflow-test/A_22068_MehrfachverordnungAblehnen.cxx
        workflow-test/TestClient.cxx
        workflow-test/Erp5827Test.cxx
        workflow-test/Erp5833Test.cxx
        workflow-test/Erp5874Test.cxx
        workflow-test/Erp5895Test.cxx
        workflow-test/Erp5898Test.cxx
        workflow-test/Erp6590Test.cxx
        workflow-test/Erp6619Test.cxx
        workflow-test/Erp8538Test.cxx
        workflow-test/Erp8545Test.cxx
        workflow-test/ErpHealthTest.cxx
        workflow-test/ErpWorkflowTest.cxx
        workflow-test/ErpWorkflow169Test.cxx
        workflow-test/ErpWorkflowTestFixture.cxx
        workflow-test/HttpsTestClient.cxx
        util/CertificateDirLoader.cxx
        util/CryptoHelper.cxx
        util/TestConfiguration.cxx
        util/EnvironmentVariableGuard.hxx
    )

add_library(erp-test-lib OBJECT ${ERP_TEST_LIB_SOURCES})
target_link_libraries(erp-test-lib
    PUBLIC
        erp-tool-lib
        CONAN_PKG::glog
        CONAN_PKG::gtest
        CONAN_PKG::gsl-lite
        CONAN_PKG::rapidjson
    )
target_include_directories(erp-test-lib
    PRIVATE
        ${CMAKE_CURRENT_BINARY_DIR}
        ${CMAKE_BINARY_DIR}
    PUBLIC
        ${CMAKE_SOURCE_DIR}
        ${CMAKE_SOURCE_DIR}/src
    )

# workaround for:
# include/rapidjson/document.h:1952:24: error: 'void* memcpy(void*, const void*, size_t)' writing to an object of type 'rapidjson::GenericValue<rapidjson::UTF8<> >::Member' {aka 'struct rapidjson::GenericMember<rapidjson::UTF8<>, rapidjson::MemoryPoolAllocator<> >'} with no trivial copy-assignment; use copy-assignment instead [-Werror=class-memaccess]
add_compile_definitions(RAPIDJSON_HAS_STDSTRING=1)
add_compile_definitions(RAPIDJSON_SCHEMA_VERBOSE=0)
if(CMAKE_CXX_COMPILER_ID MATCHES "Clang")
    add_compile_options(-Wno-class-varargs)
elseif(NOT CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
    add_compile_options(-Wno-class-memaccess)
endif()

add_compile_definitions(ENABLE_DEBUG_LOG)

list(
    APPEND erp-test-source-files
        # contains main:
        erp-test.cxx
        erp/ErpMainTest.cxx
        erp/ErpProcessingContextTest.cxx
        erp/admin/AdminRequestHandlerTest.cxx
        erp/beast/BoostBeastHeaderTest.cxx
        erp/beast/BoostBeastStringReaderTest.cxx
        erp/beast/BoostBeastStringWriterTest.cxx
        erp/client/UrlRequestSenderTest.cxx
        erp/client/request/ClientRequestTest.cxx
        erp/client/request/ClientRequestWriterTest.cxx
        erp/client/UrlRequestSenderTest.cxx
        erp/common/BoostBeastHttpStatusTest.cxx
        erp/common/BoostBeastMethodTest.cxx
        erp/common/HeaderTest.cxx
        erp/common/MimeTypeTest.cxx
        erp/compression/ZStdTest.cxx
        erp/compression/ZStdTestHelper.cxx
        erp/compression/ZStdDictionaryTest.cxx
        erp/compression/ZStdDictionaryRepositoryTest.cxx
        erp/crypto/AesGcmTest.cxx
        erp/crypto/CMACTest.cxx
        erp/crypto/CertificateTest.cxx
        erp/crypto/EllipticCurveUtilsTest.cxx
        erp/crypto/JwsTest.cxx
        erp/crypto/JwtTest.cxx
        erp/crypto/CadesBesSignatureTest.cxx
        erp/crypto/SecureRandomGeneratorTest.cxx
        erp/crypto/SeederTest.cxx
        erp/crypto/Sha256Test.cxx
        erp/database/ConsentTableTest.cxx
        erp/database/DatabaseCodecTest.cxx
        erp/database/DatabaseEncryptionTest.cxx
        erp/database/PostgresBackendTest.cxx
        erp/database/PostgresDatabaseCommunicationTest.cxx
        erp/database/PostgresDatabaseMedicationDispenseTest.cxx
        erp/database/PostgresDatabaseTaskTest.cxx
        erp/database/PostgresDatabaseTest.cxx
        erp/database/RedisClientTest.cxx
        erp/database/TransactionTest.cxx
        erp/enrolment/EnrolmentServerTest.cxx
        erp/fhir/FhirConverterTest.cxx
        erp/fhir/FhirElementTest.cxx
        erp/fhir/FhirStructureDefinitionParserTest.cxx
        erp/fhir/FhirStructureDefinitionTest.cxx
        erp/fhir/FhirStructureRepositoryTest.cxx
        erp/hsm/BlobCacheTest.cxx
        erp/hsm/BlobDatabaseTest.cxx
        erp/hsm/ErpTypesTest.cxx
        erp/hsm/HsmIdentityTest.cxx
        erp/hsm/HsmPoolSessionRemoverTest.cxx
        erp/hsm/production/ProductionBlobDatabaseTest.cxx
        erp/idp/IdpTest.cxx
        erp/idp/IdpUpdaterTest.cxx
        erp/mock/ClientTeeProtocolTest.cxx
        erp/model/AuditDataTest.cxx
        erp/model/AuditEventTest.cxx
        erp/model/BinaryTest.cxx
        erp/model/BundleTest.cxx
        erp/model/ChargeItemTest.cxx
        erp/model/CommunicationTest.cxx
        erp/model/CompositionTest.cxx
        erp/model/ConsentTest.cxx
        erp/model/DeviceTest.cxx
        erp/model/ErxReceiptTest.cxx
        erp/model/ExtensionTest.cxx
        erp/model/JsonCanonicalizationTest.cxx
        erp/model/JsonCanonicalizationTestModel.cxx
        erp/model/JsonMaintainNumberPrecisionTest.cxx
        erp/model/JsonMaintainNumberPrecisionTestModel.cxx
        erp/model/MedicationDispenseTest.cxx
        erp/model/MetaDataTest.cxx
        erp/model/OperationOutcomeTest.cxx
        erp/model/OuterResponseErrorDataTest.cxx
        erp/model/ParameterTest.cxx
        erp/model/PatientTest.cxx
        erp/model/PrescriptionIdTest.cxx
        erp/model/ResourceTest.cxx
        erp/model/ResourceVersionTest.cxx
        erp/model/SignatureTest.cxx
        erp/model/SubscriptionTest.cxx
        erp/model/TaskTest.cxx
        erp/model/TimePeriodTest.cxx
        erp/model/TimestampTest.cxx
        erp/pc/CFdSigErpManagerTest.cxx
        erp/pc/CFdSigErpTestHelper.hxx
        erp/pc/PcServiceContextTest.cxx
        erp/requirements/A_19714_SecureTransportChannel.cxx
        erp/registration/HeartbeatSenderTest.cxx
        erp/registration/RegistrationManagerTest.cxx
        erp/server/AccessLogTest.cxx
        erp/server/handler/RequestHandlerContextTest.cxx
        erp/server/pre_user_pseudonym/PreUserPseudonymManagerTest.cxx
        erp/server/pre_user_pseudonym/PreUserPseudonymTest.cxx
        erp/server/request/ServerRequestTest.cxx
        erp/server/response/ServerResponseTest.cxx
        erp/server/response/ServerResponseWriterTest.cxx
        erp/server/response/ValidatedServerResponseTest.cxx
        erp/server/telematic_pseudonym/TelematicPseudonymManagerTest.cxx
        erp/pc/SeedTimerTest.cxx
        erp/server/KeepAliveTest.cxx
        erp/server/ThreadPoolTest.cxx
        erp/service/AuditEventCreatorTest.cxx
        erp/service/CommunicationDeleteHandlerTest.cxx
        erp/service/CommunicationGetHandlerTest.cxx
        erp/service/CommunicationPostHandlerTest.cxx
        erp/service/EndpointErrorTest.cxx
        erp/service/EndpointHandlerTest.cxx
        erp/service/ErpRequestHandlerTest.cxx
        erp/service/HealthHandlerTest.cxx
        erp/service/MedicationDispenseGetHandlerTest.cxx
        erp/service/RequestHandlerBasicAuthenticationTest.cxx
        erp/service/SubscriptionHandlerTest.cxx
        erp/service/TaskAbortHandlerTest.cxx
        erp/service/VauRequestHandlerExternalInterfaceTest.cxx
        erp/service/VauRequestHandlerNotAllowedMethodsTest.cxx
        erp/service/VauRequestHandlerProblematicJwtsTest.cxx
        erp/service/VauRequestHandlerProfessionOIDTest.cxx
        erp/service/VauRequestHandlerTest.cxx
        erp/tee/ErpTeeProtocolTest.cxx
        erp/tee/InnerTeeRequestTest.cxx
        erp/tee/InnerTeeResponseTest.cxx
        erp/tee/OuterTeeRequestTest.cxx
        erp/tee/OuterTeeResponseTest.cxx
        erp/tpm/PcrSetTest.cxx
        erp/tsl/C14NHelperTest.cxx
        erp/tsl/TrustStoreTests.cxx
        erp/tsl/TslTestHelper.cxx
        erp/tsl/TslManagerTest.cxx
        erp/tsl/TslParsingExpectations.cxx
        erp/tsl/TslParsingTests.cxx
        erp/tsl/TslRefreshJobTest.cxx
        erp/tsl/TslServiceTests.cxx
        erp/tsl/X509CertificateTests.cxx
        erp/util/Base64Test.cxx
        erp/util/BufferTest.cxx
        erp/util/ByteHelperTest.cxx
        erp/util/ConditionTest.cxx
        erp/util/ConfigurationTest.cxx
        erp/util/DurationConsumerTest.cxx
        erp/util/EnvironmentTest.cxx
        erp/util/ExceptionHelperTest.cxx
        erp/util/ExceptionWrapperTest.cxx
        erp/util/JsonLogTest.cxx
        erp/util/HashTest.cxx
        erp/util/HolidaysTest.cxx
        erp/util/PeriodicTimerTest.cxx
        erp/util/RandomTest.cxx
        erp/util/RapidjsonDocumentTest.cxx
        erp/util/SafeStringTest.cxx
        erp/util/StringTest.cxx
        erp/util/TerminationHandlerTest.cxx
        erp/util/ThreadNamesTest.cxx
        erp/util/TimerTest.cxx
        erp/util/UrlHelperTest.cxx
        erp/util/UuidTest.cxx
        erp/util/search/PagingArgumentTest.cxx
        erp/util/search/SearchArgumentTest.cxx
        erp/util/search/SortArgumentTest.cxx
        erp/util/search/UrlArgumentsTest.cxx
        erp/util/WorkDayTest.cxx
        erp/validation/JsonValidatorTest.cxx
        erp/validation/KbvBundleValidationTest.cxx
        erp/validation/XmlValidatorTest.cxx
        erp/xml/SaxParserTest.cxx
        mock/MockAccountTable.cxx
        mock/MockCommunicationTable.cxx
        mock/MockBlobDatabase.cxx
        mock/MockConsentTable.cxx
        mock/MockDatabase.cxx
        mock/MockDatabaseProxy.cxx
        mock/MockIdpUpdater.cxx
        mock/MockOcsp.cxx
        mock/MockOcspServer.cxx
        mock/MockRandom.cxx
        mock/MockRedisStore.cxx
        mock/MockTaskTable.cxx
        mock/MockTerminationHandler.cxx
        mock/RegistrationMock.cxx
        mock/TestUrlArguments.cxx
        tools/HsmPoolHelper.cxx
        tools/JwtBuilderTest.cxx
        util/BlobDatabaseHelper.cxx
        util/ServerTestBase.cxx
        util/ServerTestBaseAutoCleanup.cxx
        util/StaticData.cxx
        mock/UrlRequestSenderMock.cxx
        workflow-test/EndpointTestClient.cxx
        workflow-test/Erp5822Test.cxx # contains invalid KBV bundle, can only run in erp-test
        workflow-test/Erp5899Test.cxx # contains invalid KBV bundle, can only run in erp-test
        workflow-test/Erp8090Test.cxx # contains environment changes, can only run in erp-test
)

if(ERP_WITH_HSM_TPM_PRODUCTION)
    list(
        APPEND erp-test-source-files
            erp/enrolment/EnrolmentHelperTest.cxx
            erp/hsm/HsmPoolTest.cxx
            erp/hsm/HsmSessionTest.cxx
            erp/hsm/production/HsmSessionReconnectTest.cxx
            erp/hsm/production/HsmProductionClientTest.cxx
            erp/hsm/production/HsmProductionFactoryTest.cxx
            erp/hsm/TeeTokenUpdaterTest.cxx
            erp/tpm/TpmTest.cxx
            erp/tpm/TpmProductionTest.cxx
            util/HsmTestBase.cxx
    )
endif()

add_executable(
    erp-test
        ${erp-test-source-files})

list(
    APPEND erp-connection-test-source-files

)


target_compile_definitions(erp-test PUBLIC WITH_HSM_MOCK=1)
if (ERP_WITH_HSM_TPM_PRODUCTION)
    target_compile_definitions(erp-test PUBLIC WITH_HSM_TPM_PRODUCTION=1)
    target_link_libraries(erp-test
            PUBLIC
            erp-mock-enrollmentmanager
            )
endif ()

target_include_directories (
    erp-test
            PRIVATE ${CMAKE_SOURCE_DIR}/src
            PRIVATE ${PROJECT_SOURCE_DIR}/..   # Include a leading `test/` in include paths.
            PRIVATE ${CMAKE_CURRENT_BINARY_DIR}
)

target_link_libraries ( erp-test
    PUBLIC
        erp-hsm-tpm-mock
        erp-test-lib
        erp-tool-lib
        erp-processing-context-files
        CONAN_PKG::gtest
)

add_test(
        NAME runUnitTests
        COMMAND runUnitTests
)

set(ERP_CLOUD_TEST_SOURCES
    #contains main:
    erp-integration-test.cxx
)

add_executable(erp-integration-test ${ERP_CLOUD_TEST_SOURCES})
target_compile_definitions(erp-integration-test PUBLIC WITH_HSM_MOCK=1)
if(ERP_WITH_HSM_TPM_PRODUCTION)
    target_compile_definitions(erp-integration-test PUBLIC WITH_HSM_TPM_PRODUCTION=1)
endif()

target_link_libraries(erp-integration-test
    PRIVATE
        erp-test-lib
        erp-tool-lib
        erp-processing-context-files
    )

target_include_directories(erp-integration-test
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${CMAKE_CURRENT_BINARY_DIR}
    )


add_executable(
        erp-connection-test
        ${erp-connection-test-source-files} erp-connection-test.cxx)

target_include_directories (
        erp-connection-test
        PRIVATE ${CMAKE_SOURCE_DIR}/src
        PRIVATE ${PROJECT_SOURCE_DIR}/..   # Include a leading `test/` in include paths.
        PRIVATE ${CMAKE_CURRENT_BINARY_DIR}
)

target_link_libraries (
        erp-connection-test
        PUBLIC
        erp-test-lib
        erp-tool-lib
        erp-processing-context-files
        CONAN_PKG::gtest
        )

add_custom_target(test DEPENDS erp-test erp-integration-test erp-connection-test resources)
